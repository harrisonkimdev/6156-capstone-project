<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Testing - BetaMove</title>
    <link rel="stylesheet" href="/static/app.css">
</head>

<body>
    <header class="topnav">
        <div class="inner">
            <a class="brand" href="/"><img class="brand-logo" src="/static/logo.png"
                    alt="BetaMove logo"><span>BetaMove</span></a>
            <nav>
                <a href="/">Pipeline</a>
                <a href="/training">Training</a>
                <a href="/testing" class="active">Testing</a>
                <span style="color: #666; margin: 0 12px;">|</span>
                <a href="/detection">Detection Model Training</a>
            </nav>
        </div>
    </header>
    <main class="container">
        <section class="card">
            <h1 class="title">Pipeline Step Testing</h1>
            <p class="subtitle">Test each pipeline step independently with custom inputs and validate outputs.</p>

            <div class="step-tabs">
                <div class="step-tab active" data-step="extract-frames">1. Extract Frames</div>
                <div class="step-tab" data-step="detect-holds">2. Detect Holds</div>
                <div class="step-tab" data-step="estimate-wall-angle">3. Wall Angle</div>
                <div class="step-tab" data-step="estimate-pose">4. Pose Estimation</div>
                <div class="step-tab" data-step="extract-features">5. Features</div>
            </div>

            <!-- Step 1: Extract Frames -->
            <div class="step-section active" data-step="extract-frames">
                <h2>Frame Extraction</h2>
                <form id="form-extract-frames" class="form">
                    <div class="form-row">
                        <label for="video_file">Video File</label>
                        <input type="file" id="video_file" name="video_file" accept="video/*" required>
                        <p class="hint">Upload a video file or provide path to existing video</p>
                    </div>
                    <div class="form-row">
                        <label for="interval">Interval (seconds)</label>
                        <input type="number" id="interval" name="interval" value="1.0" min="0.1" step="0.1" required>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="button">Execute Step</button>
                        <span id="status-extract-frames" class="status"></span>
                    </div>
                </form>
                <div class="output-section" id="output-extract-frames" style="display: none;">
                    <h3>Output <span class="validation-result pending" id="validation-extract-frames">Pending</span>
                    </h3>
                    <div id="result-extract-frames"></div>
                    <div class="log-output" id="log-extract-frames"></div>
                </div>
            </div>

            <!-- Step 2: Detect Holds -->
            <div class="step-section" data-step="detect-holds">
                <h2>Hold Detection</h2>
                <form id="form-detect-holds" class="form">
                    <div class="form-row">
                        <label for="frame_dir">Frame Directory</label>
                        <input type="text" id="frame_dir" name="frame_dir" placeholder="data/frames/video01" required>
                        <p class="hint">Path to directory containing frame images (from Step 1)</p>
                    </div>
                    <div class="form-row inline">
                        <div>
                            <label for="model_name">YOLO Model</label>
                            <input type="text" id="model_name" name="model_name" value="yolov8n.pt">
                        </div>
                        <div>
                            <label for="eps">DBSCAN Epsilon</label>
                            <input type="number" id="eps" name="eps" value="0.03" step="0.01" min="0">
                        </div>
                        <div>
                            <label for="min_samples">Min Samples</label>
                            <input type="number" id="min_samples" name="min_samples" value="3" min="1">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="checkbox">
                            <input type="checkbox" id="use_tracking" name="use_tracking" checked>
                            <label for="use_tracking">Use temporal tracking</label>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="button">Execute Step</button>
                        <span id="status-detect-holds" class="status"></span>
                    </div>
                </form>
                <div class="output-section" id="output-detect-holds" style="display: none;">
                    <h3>Output <span class="validation-result pending" id="validation-detect-holds">Pending</span></h3>
                    <div id="result-detect-holds"></div>
                    <div class="log-output" id="log-detect-holds"></div>
                </div>
            </div>

            <!-- Step 3: Wall Angle -->
            <div class="step-section" data-step="estimate-wall-angle">
                <h2>Wall Angle Estimation</h2>
                <form id="form-estimate-wall-angle" class="form">
                    <div class="form-row">
                        <label for="image_path">Image Path</label>
                        <input type="text" id="image_path" name="image_path"
                            placeholder="data/frames/video01/frame_0000.jpg" required>
                        <p class="hint">Path to representative frame image</p>
                    </div>
                    <div class="form-row">
                        <label for="hold_centers">Hold Centers (Optional)</label>
                        <textarea id="hold_centers" name="hold_centers" placeholder='[[0.5, 0.3], [0.6, 0.4]]'
                            rows="3"></textarea>
                        <p class="hint">JSON array of [x, y] coordinates (normalized 0-1)</p>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="button">Execute Step</button>
                        <span id="status-estimate-wall-angle" class="status"></span>
                    </div>
                </form>
                <div class="output-section" id="output-estimate-wall-angle" style="display: none;">
                    <h3>Output <span class="validation-result pending"
                            id="validation-estimate-wall-angle">Pending</span></h3>
                    <div id="result-estimate-wall-angle"></div>
                    <div class="log-output" id="log-estimate-wall-angle"></div>
                </div>
            </div>

            <!-- Step 4: Pose Estimation -->
            <div class="step-section" data-step="estimate-pose">
                <h2>Pose Estimation</h2>
                <form id="form-estimate-pose" class="form">
                    <div class="form-row">
                        <label for="manifest_path">Manifest Path</label>
                        <input type="text" id="manifest_path" name="manifest_path"
                            placeholder="data/frames/video01/manifest.json" required>
                        <p class="hint">Path to manifest.json (from Step 1)</p>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="button">Execute Step</button>
                        <span id="status-estimate-pose" class="status"></span>
                    </div>
                </form>
                <div class="output-section" id="output-estimate-pose" style="display: none;">
                    <h3>Output <span class="validation-result pending" id="validation-estimate-pose">Pending</span></h3>
                    <div id="result-estimate-pose"></div>
                    <div class="log-output" id="log-estimate-pose"></div>
                </div>
            </div>

            <!-- Step 5: Feature Extraction -->
            <div class="step-section" data-step="extract-features">
                <h2>Feature Extraction</h2>
                <p class="hint">This step includes segmentation and efficiency scoring.</p>
                <form id="form-extract-features" class="form">
                    <div class="form-row">
                        <label for="manifest_path_features">Manifest Path</label>
                        <input type="text" id="manifest_path_features" name="manifest_path"
                            placeholder="data/frames/video01/manifest.json" required>
                        <p class="hint">Path to manifest.json (from Step 1)</p>
                    </div>
                    <div class="form-row">
                        <label for="holds_path">Holds Path (Optional)</label>
                        <input type="text" id="holds_path" name="holds_path"
                            placeholder="data/frames/video01/holds.json">
                        <p class="hint">Path to holds.json (from Step 2)</p>
                    </div>
                    <div class="form-row inline">
                        <div class="checkbox">
                            <input type="checkbox" id="auto_wall_angle" name="auto_wall_angle" checked>
                            <label for="auto_wall_angle">Auto-estimate wall angle</label>
                        </div>
                    </div>
                    <div class="form-row inline">
                        <div>
                            <label for="climber_height">Climber Height (cm)</label>
                            <input type="number" id="climber_height" name="climber_height" min="0" max="250">
                        </div>
                        <div>
                            <label for="climber_wingspan">Wingspan (cm)</label>
                            <input type="number" id="climber_wingspan" name="climber_wingspan" min="0" max="300">
                        </div>
                        <div>
                            <label for="climber_flexibility">Flexibility (0-1)</label>
                            <input type="number" id="climber_flexibility" name="climber_flexibility" min="0" max="1"
                                step="0.1">
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="button">Execute Step</button>
                        <span id="status-extract-features" class="status"></span>
                    </div>
                </form>
                <div class="output-section" id="output-extract-features" style="display: none;">
                    <h3>Output <span class="validation-result pending" id="validation-extract-features">Pending</span>
                    </h3>
                    <div id="result-extract-features"></div>
                    <div class="log-output" id="log-extract-features"></div>
                </div>
            </div>
        </section>
    </main>

    <script src="/static/feedback-widget.js"></script>
    <script src="/static/job-notifications.js"></script>
    <script>
        // Tab switching
        document.querySelectorAll('.step-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const step = tab.dataset.step;
                document.querySelectorAll('.step-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.step-section').forEach(s => s.classList.remove('active'));
                tab.classList.add('active');
                document.querySelector(`.step-section[data-step="${step}"]`).classList.add('active');
            });
        });

        // Helper functions
        function formatJSON(obj) {
            return JSON.stringify(obj, null, 2);
        }

        function updateStatus(step, message) {
            const statusEl = document.getElementById(`status-${step}`);
            if (statusEl) statusEl.textContent = message;
        }

        function showOutput(step, data, log = '') {
            const outputEl = document.getElementById(`output-${step}`);
            const resultEl = document.getElementById(`result-${step}`);
            const logEl = document.getElementById(`log-${step}`);

            if (outputEl) outputEl.style.display = 'block';
            if (resultEl) {
                resultEl.innerHTML = `<div class="json-viewer">${formatJSON(data)}</div>`;
            }
            if (logEl) logEl.textContent = log;
        }

        function updateValidation(step, status) {
            const valEl = document.getElementById(`validation-${step}`);
            if (valEl) {
                valEl.className = `validation-result ${status}`;
                valEl.textContent = status === 'success' ? '✓ Valid' : status === 'error' ? '✗ Invalid' : 'Pending';
            }
        }

        // Step 1: Extract Frames
        document.getElementById('form-extract-frames').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const videoFile = formData.get('video_file');
            const interval = parseFloat(formData.get('interval'));

            updateStatus('extract-frames', 'Uploading and processing...');

            try {
                // First upload video if it's a file
                let videoPath = videoFile.name;
                if (videoFile instanceof File) {
                    const uploadForm = new FormData();
                    uploadForm.append('video', videoFile);
                    const uploadRes = await fetch('/api/upload', {
                        method: 'POST',
                        body: uploadForm,
                    });
                    const uploadData = await uploadRes.json();
                    videoPath = uploadData.video_dir;
                }

                const response = await fetch('/api/test/extract-frames', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        video_file: videoPath,
                        interval: interval,
                    }),
                });

                const data = await response.json();
                if (!response.ok) {
                    throw new Error(data.detail || 'Request failed');
                }

                showOutput('extract-frames', data, `Successfully extracted ${data.saved_frames} frames`);
                updateValidation('extract-frames', 'success');
                updateStatus('extract-frames', 'Complete');
            } catch (err) {
                showOutput('extract-frames', { error: err.message }, err.message);
                updateValidation('extract-frames', 'error');
                updateStatus('extract-frames', 'Failed');
            }
        });

        // Step 2: Detect Holds
        document.getElementById('form-detect-holds').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);

            updateStatus('detect-holds', 'Processing...');

            try {
                const response = await fetch('/api/test/detect-holds', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        frame_dir: formData.get('frame_dir'),
                        model_name: formData.get('model_name') || 'yolov8n.pt',
                        eps: parseFloat(formData.get('eps') || '0.03'),
                        min_samples: parseInt(formData.get('min_samples') || '3'),
                        use_tracking: formData.get('use_tracking') === 'on',
                    }),
                });

                const data = await response.json();
                if (!response.ok) {
                    throw new Error(data.detail || 'Request failed');
                }

                showOutput('detect-holds', data, `Detected ${data.holds_count} holds`);
                updateValidation('detect-holds', 'success');
                updateStatus('detect-holds', 'Complete');
            } catch (err) {
                showOutput('detect-holds', { error: err.message }, err.message);
                updateValidation('detect-holds', 'error');
                updateStatus('detect-holds', 'Failed');
            }
        });

        // Step 3: Wall Angle
        document.getElementById('form-estimate-wall-angle').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);

            updateStatus('estimate-wall-angle', 'Processing...');

            try {
                const holdCentersText = formData.get('hold_centers');
                let holdCenters = null;
                if (holdCentersText) {
                    holdCenters = JSON.parse(holdCentersText);
                }

                const response = await fetch('/api/test/estimate-wall-angle', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        image_path: formData.get('image_path'),
                        hold_centers: holdCenters,
                    }),
                });

                const data = await response.json();
                if (!response.ok) {
                    throw new Error(data.detail || 'Request failed');
                }

                showOutput('estimate-wall-angle', data, `Wall angle: ${data.result.angle_degrees}° (confidence: ${data.result.confidence})`);
                updateValidation('estimate-wall-angle', 'success');
                updateStatus('estimate-wall-angle', 'Complete');
            } catch (err) {
                showOutput('estimate-wall-angle', { error: err.message }, err.message);
                updateValidation('estimate-wall-angle', 'error');
                updateStatus('estimate-wall-angle', 'Failed');
            }
        });

        // Step 4: Pose Estimation
        document.getElementById('form-estimate-pose').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);

            updateStatus('estimate-pose', 'Processing...');

            try {
                const response = await fetch('/api/test/estimate-pose', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        manifest_path: formData.get('manifest_path'),
                    }),
                });

                const data = await response.json();
                if (!response.ok) {
                    throw new Error(data.detail || 'Request failed');
                }

                showOutput('estimate-pose', data, `Processed ${data.frames_processed} frames`);
                updateValidation('estimate-pose', 'success');
                updateStatus('estimate-pose', 'Complete');
            } catch (err) {
                showOutput('estimate-pose', { error: err.message }, err.message);
                updateValidation('estimate-pose', 'error');
                updateStatus('estimate-pose', 'Failed');
            }
        });

        // Step 5: Feature Extraction
        document.getElementById('form-extract-features').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);

            updateStatus('extract-features', 'Processing...');

            try {
                const response = await fetch('/api/test/extract-features', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        manifest_path: formData.get('manifest_path'),
                        holds_path: formData.get('holds_path') || null,
                        auto_wall_angle: formData.get('auto_wall_angle') === 'on',
                        climber_height: formData.get('climber_height') ? parseFloat(formData.get('climber_height')) : null,
                        climber_wingspan: formData.get('climber_wingspan') ? parseFloat(formData.get('climber_wingspan')) : null,
                        climber_flexibility: formData.get('climber_flexibility') ? parseFloat(formData.get('climber_flexibility')) : null,
                    }),
                });

                const data = await response.json();
                if (!response.ok) {
                    throw new Error(data.detail || 'Request failed');
                }

                showOutput('extract-features', data, `Extracted ${data.features_count} feature rows, ${data.efficiency_count} efficiency scores`);
                updateValidation('extract-features', 'success');
                updateStatus('extract-features', 'Complete');
            } catch (err) {
                showOutput('extract-features', { error: err.message }, err.message);
                updateValidation('extract-features', 'error');
                updateStatus('extract-features', 'Failed');
            }
        });
    </script>
</body>

</html>