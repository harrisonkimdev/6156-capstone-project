<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Pipeline - BetaMove</title>
    <link rel="stylesheet" href="/static/app.css">
</head>

<body>
    <header class="topnav">
        <div class="inner">
            <a class="brand" href="/"><img class="brand-logo" src="/static/logo.png"
                    alt="BetaMove logo"><span>BetaMove</span></a>
            <nav>
                <a href="/" class="active">Pipeline</a>
                <a href="/training">Training</a>
                <a href="/testing">Testing</a>
                <span style="color: #666; margin: 0 12px;">|</span>
                <a href="/detection">Detection Model Training</a>
            </nav>
        </div>
    </header>
    <main class="container">
        <section class="card">
            <h1 class="title">BetaMove Pipeline</h1>
            <p class="subtitle">Run the end-to-end pose analysis pipeline from your browser.</p>
            <form id="pipeline-form" class="form">
                <div class="form-row">
                    <label for="video_file">Upload video</label>
                    <input type="file" id="video_file" name="video" accept="video/*" required>
                    <p class="hint">The uploaded video will be used for this run.</p>
                </div>
                <div class="form-row">
                    <label for="output_dir">Output directory</label>
                    <input type="text" id="output_dir" name="output_dir" value="data/frames" required>
                </div>
                <fieldset>
                    <legend>YOLO still selection</legend>
                    <div class="form-row inline">
                        <div class="checkbox">
                            <input type="checkbox" id="enable_yolo" name="enable_yolo" checked>
                            <label for="enable_yolo">Enable YOLO filtering</label>
                        </div>
                        <div>
                            <label for="yolo_min_confidence">Min confidence</label>
                            <input type="number" id="yolo_min_confidence" name="yolo_min_confidence" min="0" max="1"
                                step="0.05" value="0.35">
                        </div>
                        <div>
                            <label for="yolo_max_frames">Max frames</label>
                            <input type="number" id="yolo_max_frames" name="yolo_max_frames" min="1" placeholder="auto">
                        </div>
                    </div>
                    <div class="form-row">
                        <label for="yolo_required_labels">Required labels</label>
                        <input type="text" id="yolo_required_labels" name="yolo_required_labels" value="climber,person">
                        <p class="hint">Frame is kept when any of these labels exceed the confidence threshold.</p>
                    </div>
                    <div class="form-row">
                        <label for="yolo_target_labels">Target labels</label>
                        <input type="text" id="yolo_target_labels" name="yolo_target_labels"
                            value="climber,person,hold,wall">
                    </div>
                    <div class="form-row inline">
                        <div>
                            <label for="yolo_model_name">Model weights</label>
                            <input type="text" id="yolo_model_name" name="yolo_model_name" value="yolov8n.pt">
                        </div>
                        <div>
                            <label for="yolo_imgsz">Image size</label>
                            <input type="number" id="yolo_imgsz" name="yolo_imgsz" value="640" min="128" max="1536"
                                step="32">
                        </div>
                        <div>
                            <label for="yolo_device">Device override</label>
                            <input type="text" id="yolo_device" name="yolo_device" placeholder="cpu / cuda:0">
                        </div>
                    </div>
                </fieldset>
                <div class="form-actions">
                    <button id="run" type="submit">Run pipeline</button>
                    <button id="clear" type="button" class="secondary-btn">Clear</button>
                    <span id="form-status" class="status"></span>
                </div>
            </form>
        </section>

        <section class="card">
            <div class="card-header">
                <h2>Runs</h2>
                <button id="refresh" type="button">Refresh</button>
            </div>
            <div class="table-wrapper">
                <table id="jobs-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Status</th>
                            <th>Video dir</th>
                            <th>Created</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for job in jobs %}
                        <tr data-job-id="{{ job.id }}">
                            <td>{{ job.id }}</td>
                            <td class="status-cell"><span class="badge badge-{{ job.status }}">{{ job.status }}</span>
                            </td>
                            <td>{{ job.video_dir }}</td>
                            <td>{{ job.created_at }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <p class="hint">Select a run to inspect its logs.</p>
        </section>

        <section class="card">
            <div class="card-header">
                <h2>Logs</h2>
                <span id="log-title">No run selected</span>
            </div>
            <pre id="log-output" class="log-output"></pre>
        </section>

        <section class="card">
            <div class="card-header">
                <h2>Visualizations</h2>
            </div>
            <div id="visual-grid" class="image-grid">
                <p class="hint">No visualizations yet. Run the pipeline with visualization enabled.</p>
            </div>
        </section>

        <section class="card">
            <div class="card-header">
                <h2>Pose Samples</h2>
                <span id="pose-count" class="secondary"></span>
            </div>
            <div class="table-wrapper">
                <table id="pose-table">
                    <thead>
                        <tr>
                            <th>Image</th>
                            <th>Timestamp (s)</th>
                            <th>Detection Score</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <p id="pose-empty" class="hint">No pose sample data yet.</p>
        </section>

        <section class="card">
            <div class="card-header">
                <h2>Efficiency & Recommendations</h2>
                <button id="analysis-refresh" type="button">Refresh</button>
            </div>
            <div id="efficiency-block">
                <p class="hint" id="efficiency-hint">Select a completed run to view analysis.</p>
                <div id="efficiency-score" class="metrics"></div>
                <table id="next-holds-table" class="compact">
                    <thead>
                        <tr>
                            <th>Hold ID</th>
                            <th>Label</th>
                            <th>Coords</th>
                            <th>Score Heuristic</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </section>
    </main>

    <script>
        const form = document.getElementById("pipeline-form");
        const statusEl = document.getElementById("form-status");
        const jobsTableBody = document.querySelector("#jobs-table tbody");
        const logOutput = document.getElementById("log-output");
        const logTitle = document.getElementById("log-title");
        const refreshButton = document.getElementById("refresh");
        const fileInput = document.getElementById("video_file");
        const visualGrid = document.getElementById("visual-grid");
        const poseTableBody = document.querySelector("#pose-table tbody");
        const poseEmpty = document.getElementById("pose-empty");
        const poseCount = document.getElementById("pose-count");
        const clearButton = document.getElementById("clear");
        const runButton = document.getElementById("run");
        let selectedJobId = null;

        async function createJob(payload) {
            const response = await fetch("/api/jobs", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });
            if (!response.ok) {
                const error = await response.json().catch(() => ({}));
                throw new Error(error.detail || "Failed to start pipeline run");
            }
            return response.json();
        }

        function serializeForm(formData) {
            const parseList = (value) => (value || "")
                .split(",")
                .map(item => item.trim())
                .filter(Boolean);
            const parseNumber = (value, fallback) => {
                if (value === undefined || value === null || value === "") {
                    return fallback;
                }
                const num = Number(value);
                return Number.isFinite(num) ? num : fallback;
            };
            const minConfidence = parseNumber(formData.get("yolo_min_confidence"), 0.35);
            const maxFramesRaw = formData.get("yolo_max_frames");
            const maxFrames = maxFramesRaw ? parseNumber(maxFramesRaw, null) : null;
            const yolo = {
                enabled: formData.get("enable_yolo") === "on",
                min_confidence: minConfidence,
                required_labels: parseList(formData.get("yolo_required_labels")),
                target_labels: parseList(formData.get("yolo_target_labels")),
                max_frames: maxFrames && maxFrames > 0 ? maxFrames : null,
                model_name: formData.get("yolo_model_name") || "yolov8n.pt",
                imgsz: parseNumber(formData.get("yolo_imgsz"), 640),
                device: formData.get("yolo_device") || null,
            };
            return {
                output_dir: formData.get("output_dir"),
                yolo,
            };
        }

        async function uploadSelectedVideo() {
            if (!fileInput || !fileInput.files || fileInput.files.length === 0) {
                throw new Error("Please select a video file.");
            }
            const uploadData = new FormData();
            uploadData.append("video", fileInput.files[0]);
            const response = await fetch("/api/upload", {
                method: "POST",
                body: uploadData,
            });
            if (!response.ok) {
                const error = await response.json().catch(() => ({}));
                throw new Error(error.detail || "Video upload failed");
            }
            return response.json();
        }

        async function fetchJobs() {
            const response = await fetch("/api/jobs");
            if (!response.ok) {
                throw new Error("Failed to fetch jobs");
            }
            return response.json();
        }

        function renderVisualizations(items) {
            if (!visualGrid) {
                return;
            }
            if (!items || items.length === 0) {
                visualGrid.innerHTML = '<p class="hint">No visualizations yet. Run the pipeline with visualization enabled.</p>';
                return;
            }
            visualGrid.innerHTML = "";
            items.forEach((item) => {
                const figure = document.createElement("figure");
                const link = document.createElement("a");
                link.href = item.url;
                link.target = "_blank";
                link.rel = "noopener noreferrer";

                const img = document.createElement("img");
                img.src = item.url;
                img.alt = item.label || "visualization";
                link.appendChild(img);
                figure.appendChild(link);

                if (item.label) {
                    const caption = document.createElement("figcaption");
                    caption.textContent = item.label;
                    figure.appendChild(caption);
                }
                visualGrid.appendChild(figure);
            });
        }

        function renderPoseSamples(samples) {
            if (!poseTableBody) {
                return;
            }
            poseTableBody.innerHTML = "";
            if (!samples || samples.length === 0) {
                if (poseEmpty) {
                    poseEmpty.style.display = "block";
                }
                if (poseCount) {
                    poseCount.textContent = "";
                }
                return;
            }
            if (poseEmpty) {
                poseEmpty.style.display = "none";
            }
            if (poseCount) {
                poseCount.textContent = `${samples.length} frames`;
            }

            samples.forEach((sample) => {
                const row = document.createElement("tr");

                const imageCell = document.createElement("td");
                if (sample.image_url) {
                    const link = document.createElement("a");
                    link.href = sample.image_url;
                    link.target = "_blank";
                    link.rel = "noopener noreferrer";
                    link.textContent = sample.image_name || sample.image_path || "view";
                    imageCell.appendChild(link);
                } else {
                    imageCell.textContent = sample.image_name || sample.image_path || "—";
                }
                row.appendChild(imageCell);

                const timestampCell = document.createElement("td");
                const timestamp = Number(sample.timestamp_seconds);
                timestampCell.textContent = Number.isFinite(timestamp) ? timestamp.toFixed(2) : "—";
                row.appendChild(timestampCell);

                const scoreCell = document.createElement("td");
                const score = Number(sample.detection_score);
                scoreCell.textContent = Number.isFinite(score) ? score.toFixed(3) : "—";
                row.appendChild(scoreCell);

                poseTableBody.appendChild(row);
            });
        }

        async function clearServerJob(jobId) {
            const response = await fetch(`/api/jobs/${jobId}/clear`, { method: "POST" });
            if (!response.ok) {
                const error = await response.json().catch(() => ({}));
                throw new Error(error.detail || "Failed to clear job");
            }
            return response.json();
        }

        function clearDisplays() {
            logTitle.textContent = "No run selected";
            document.getElementById("log-output").textContent = "";
            renderVisualizations([]);
            renderPoseSamples([]);
        }

        function renderJobs(jobs) {
            jobsTableBody.innerHTML = "";
            jobs.forEach(job => {
                const row = document.createElement("tr");
                row.dataset.jobId = job.id;
                row.innerHTML = `
            <td>${job.id}</td>
            <td class="status-cell">${job.status}</td>
            <td>${job.video_dir}</td>
            <td>${job.interval.toFixed ? job.interval.toFixed(2) : job.interval}</td>
            <td>${job.created_at}</td>
        `;
                if (job.id === selectedJobId) {
                    row.classList.add("selected");
                }
                row.addEventListener("click", () => {
                    selectedJobId = job.id;
                    loadLogs(job.id);
                    renderJobs(jobs);
                });
                jobsTableBody.appendChild(row);
            });
        }

        async function refreshJobs() {
            try {
                const jobs = await fetchJobs();
                renderJobs(jobs);
                if (selectedJobId) {
                    await loadLogs(selectedJobId);
                }
            } catch (err) {
                console.error(err);
            }
        }

        async function loadLogs(jobId) {
            try {
                const response = await fetch(`/api/jobs/${jobId}`);
                if (!response.ok) {
                    throw new Error("Failed to fetch job logs");
                }
                const data = await response.json();
                logTitle.textContent = `Run ${data.id} (${data.status})`;
                logOutput.textContent = data.logs.join("\\n") || "No logs yet.";
                renderVisualizations(data.visualizations || []);
                renderPoseSamples(data.pose_samples || []);
                await loadAnalysis(jobId);
            } catch (err) {
                logTitle.textContent = "Unable to load logs";
                logOutput.textContent = String(err);
                renderVisualizations([]);
                renderPoseSamples([]);
                clearAnalysis();
            }
        }

        async function loadAnalysis(jobId) {
            const scoreEl = document.getElementById("efficiency-score");
            const hintEl = document.getElementById("efficiency-hint");
            const tableBody = document.querySelector("#next-holds-table tbody");
            if (!jobId || !scoreEl || !tableBody) return;
            try {
                const resp = await fetch(`/api/jobs/${jobId}/analysis`);
                if (!resp.ok) throw new Error("Analysis endpoint error");
                const payload = await resp.json();
                const eff = payload.efficiency || {};
                scoreEl.innerHTML = `<strong>Efficiency:</strong> ${Number(eff.score).toFixed(3)}<br>` +
                    Object.entries(eff).filter(([k]) => k !== "score").map(([k, v]) => `${k}: ${Number(v).toFixed ? Number(v).toFixed(3) : v}`).join(" | ");
                if (hintEl) hintEl.textContent = `Wall angle: ${payload.wall_angle !== null && payload.wall_angle !== undefined ? Number(payload.wall_angle).toFixed(1) + '°' : 'n/a'} | Holds: ${payload.holds_count}`;
                tableBody.innerHTML = "";
                (payload.next_holds || []).forEach(h => {
                    const tr = document.createElement("tr");
                    tr.innerHTML = `<td>${h.hold_id || h.holdId || '—'}</td><td>${h.label || '—'}</td><td>${(h.coords || []).map(c => Number(c).toFixed(3)).join(',')}</td><td>${h.avg_confidence !== undefined ? Number(h.avg_confidence).toFixed(3) : '—'}</td>`;
                    tableBody.appendChild(tr);
                });
            } catch (err) {
                if (scoreEl) scoreEl.textContent = "Analysis unavailable";
            }
        }

        function clearAnalysis() {
            const scoreEl = document.getElementById("efficiency-score");
            const tableBody = document.querySelector("#next-holds-table tbody");
            if (scoreEl) scoreEl.textContent = "";
            if (tableBody) tableBody.innerHTML = "";
            const hintEl = document.getElementById("efficiency-hint");
            if (hintEl) hintEl.textContent = "Select a completed run to view analysis.";
        }

        const analysisRefresh = document.getElementById("analysis-refresh");
        if (analysisRefresh) {
            analysisRefresh.addEventListener("click", () => {
                if (selectedJobId) loadAnalysis(selectedJobId);
            });
        }

        form.addEventListener("submit", async (event) => {
            event.preventDefault();
            statusEl.textContent = "Starting…";
            try {
                const formData = new FormData(form);
                const payload = serializeForm(formData);
                statusEl.textContent = "Uploading video…";
                const uploadResult = await uploadSelectedVideo();
                payload.video_dir = uploadResult.video_dir;
                if (uploadResult.gcs_uri) {
                    payload.source_uri = uploadResult.gcs_uri;
                }
                const job = await createJob(payload);
                statusEl.textContent = `Started run ${job.id}`;
                if (fileInput) {
                    fileInput.value = "";
                }
                selectedJobId = job.id;
                await refreshJobs();
            } catch (err) {
                statusEl.textContent = err.message;
            }
        });

        refreshButton.addEventListener("click", refreshJobs);
        setInterval(refreshJobs, 5000);
        renderVisualizations([]);
        renderPoseSamples([]);
        refreshJobs();

        if (clearButton) {
            clearButton.addEventListener("click", async () => {
                try {
                    if (selectedJobId) {
                        await clearServerJob(selectedJobId);
                        await loadLogs(selectedJobId);
                    } else {
                        clearDisplays();
                    }
                } catch (err) {
                    console.error(err);
                }
            });
        }

        function updateIntervalLabel() {
            if (intervalInput && intervalValue) {
                const val = parseFloat(intervalInput.value || "1.0");
                intervalValue.textContent = (Number.isFinite(val) ? val.toFixed(1) : "1.0");
            }
        }
        if (intervalInput) {
            intervalInput.addEventListener("input", updateIntervalLabel);
            updateIntervalLabel();
        }
    </script>
</body>

</html>