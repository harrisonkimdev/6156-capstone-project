<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Analysis - BetaMove</title>
    <link rel="stylesheet" href="/static/app.css">
    <style>
        /* Progress Steps */
        .progress-steps {
            display: flex;
            justify-content: space-between;
            gap: 8px;
            padding: 16px;
            background: var(--card-bg, #1e1e1e);
            border-radius: 8px;
            flex-wrap: wrap;
        }

        .progress-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 12px 16px;
            background: #2a2a2a;
            border-radius: 6px;
            min-width: 100px;
            transition: all 0.3s ease;
        }

        .progress-step .step-icon {
            font-size: 24px;
            margin-bottom: 4px;
        }

        .progress-step .step-name {
            font-size: 12px;
            color: #888;
            margin-bottom: 4px;
        }

        .progress-step .step-status {
            font-size: 11px;
            color: #666;
        }

        .progress-step.completed {
            background: #1a3d1a;
            border: 1px solid #2d5a2d;
        }

        .progress-step.completed .step-status {
            color: #4ade80;
        }

        .progress-step.active {
            background: #1a2d4d;
            border: 1px solid #2d4a7d;
            animation: pulse 1.5s infinite;
        }

        .progress-step.active .step-status {
            color: #60a5fa;
        }

        .progress-step.failed {
            background: #3d1a1a;
            border: 1px solid #5a2d2d;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.7;
            }
        }

        /* Video and Recommendations Grid */
        .visualization-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 900px) {
            .visualization-grid {
                grid-template-columns: 1fr;
            }
        }

        .video-player-container {
            background: #000;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
            min-height: 200px;
        }

        .video-player-container video {
            width: 100%;
            height: auto;
            max-height: 400px;
            display: block;
            object-fit: contain;
        }

        .recommendations-panel {
            background: #1e1e1e;
            border-radius: 8px;
            padding: 16px;
        }

        .recommendation-card {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: #2a2a2a;
            border-radius: 6px;
            margin-bottom: 8px;
            transition: background 0.2s;
        }

        .recommendation-card:hover {
            background: #333;
        }

        .recommendation-card .hold-type {
            font-weight: bold;
            color: #fff;
        }

        .recommendation-card .hold-info {
            font-size: 12px;
            color: #888;
        }

        .recommendation-card .confidence {
            margin-left: auto;
            font-size: 14px;
            color: #4ade80;
        }

        /* Climber Profile Form */
        .climber-profile {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            padding: 16px;
            background: #1e1e1e;
            border-radius: 8px;
            margin-bottom: 16px;
        }

        @media (max-width: 600px) {
            .climber-profile {
                grid-template-columns: 1fr;
            }
        }

        .climber-profile .form-group {
            display: flex;
            flex-direction: column;
        }

        .climber-profile label {
            font-size: 12px;
            color: #888;
            margin-bottom: 4px;
        }

        .climber-profile input {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #444;
            background: #2a2a2a;
            color: #fff;
        }

        /* Low Efficiency Frames */
        .efficiency-badge {
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }

        .efficiency-badge.low {
            background: #dc2626;
            color: #fff;
        }

        .efficiency-badge.medium {
            background: #f59e0b;
            color: #000;
        }

        .efficiency-badge.high {
            background: #22c55e;
            color: #000;
        }
    </style>
</head>

<body>
    <header class="topnav">
        <div class="inner">
            <a class="brand" href="/"><img class="brand-logo" src="/static/logo.png"
                    alt="BetaMove logo"><span>BetaMove</span></a>
            <nav>
                <a href="/" class="active">Analysis</a>
                <a href="/training">Training</a>
                <span style="color: #666; margin: 0 12px;">|</span>
                <a href="/detection">Detection Model Training</a>
            </nav>
        </div>
    </header>
    <main class="container">
        <section class="card">
            <h1 class="title">BetaMove Analysis</h1>
            <p class="subtitle">Test your trained models by uploading a climbing video for analysis.</p>
            <form id="pipeline-form" class="form">
                <div class="form-row">
                    <label for="video_file">Upload video</label>
                    <input type="file" id="video_file" name="video" accept="video/*" required>
                    <p class="hint">Upload a climbing video to analyze with your trained models.</p>
                </div>
                <div class="form-actions">
                    <button id="run" type="submit">Analyze Video</button>
                    <button id="clear" type="button" class="secondary-btn">Clear</button>
                    <span id="form-status" class="status"></span>
                </div>
            </form>
        </section>

        <section class="card">
            <div class="card-header">
                <h2>Analysis Runs</h2>
                <button id="refresh" type="button">Refresh</button>
            </div>
            <div class="table-wrapper">
                <table id="jobs-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Status</th>
                            <th>Progress</th>
                            <th>Duration</th>
                            <th>Frames</th>
                            <th>Created</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for job in jobs %}
                        <tr data-job-id="{{ job.id }}">
                            <td>{{ job.id[:8] }}...</td>
                            <td class="status-cell"><span class="badge badge-{{ job.status }}">{{ job.status }}</span>
                            </td>
                            <td>-</td>
                            <td>-</td>
                            <td>-</td>
                            <td>{{ job.created_at }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <p class="hint">Select a run to view details and analysis results.</p>
        </section>

        <section class="card">
            <div class="card-header">
                <h2>Processing Status</h2>
                <span id="log-title">No run selected</span>
            </div>
            <div id="progress-steps" class="progress-steps" style="display: none; margin-bottom: 16px;">
                <div class="progress-step" data-step="upload">
                    <span class="step-icon">üì§</span>
                    <span class="step-name">Upload</span>
                    <span class="step-status">-</span>
                </div>
                <div class="progress-step" data-step="extract">
                    <span class="step-icon">üéûÔ∏è</span>
                    <span class="step-name">Frame Extraction</span>
                    <span class="step-status">-</span>
                </div>
                <div class="progress-step" data-step="detect">
                    <span class="step-icon">üéØ</span>
                    <span class="step-name">Hold Detection</span>
                    <span class="step-status">-</span>
                </div>
                <div class="progress-step" data-step="pose">
                    <span class="step-icon">üèÉ</span>
                    <span class="step-name">Pose Estimation</span>
                    <span class="step-status">-</span>
                </div>
                <div class="progress-step" data-step="features">
                    <span class="step-icon">üìä</span>
                    <span class="step-name">Feature Extraction</span>
                    <span class="step-status">-</span>
                </div>
                <div class="progress-step" data-step="analysis">
                    <span class="step-icon">üß†</span>
                    <span class="step-name">Analysis</span>
                    <span class="step-status">-</span>
                </div>
            </div>
            <details id="log-details">
                <summary>Show Detailed Logs</summary>
                <pre id="log-output" class="log-output"></pre>
            </details>
        </section>

        <section class="card">
            <div class="card-header">
                <h2>Video Analysis</h2>
                <span id="frame-info" class="secondary"></span>
            </div>
            <div class="visualization-grid">
                <!-- Left: Video Player -->
                <div class="video-player-container">
                    <video id="analysis-video">
                        <source src="" type="video/mp4">
                        Your browser does not support the video tag.
                    </video>
                    <div id="video-placeholder" class="hint" style="padding: 40px; text-align: center;">
                        Select a completed analysis run to view the video
                    </div>
                </div>
                <!-- Right: Next Move Recommendations -->
                <div class="recommendations-panel">
                    <h3 style="color: #fff; margin-top: 0; margin-bottom: 12px; font-size: 16px;">
                        Next Move Candidates
                    </h3>
                    <div id="recommendations-list">
                        <p class="hint">Pause the video to see recommended next moves for that frame.</p>
                    </div>
                    <div id="current-contacts" style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #333;">
                        <h4 style="color: #888; margin: 0 0 8px 0; font-size: 12px; text-transform: uppercase;">
                            Current Contact Points
                        </h4>
                        <div id="contacts-display" style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                            <div class="contact-item" data-limb="left_hand">
                                <span style="color: #888;">Left Hand:</span> <span class="contact-value">-</span>
                            </div>
                            <div class="contact-item" data-limb="right_hand">
                                <span style="color: #888;">Right Hand:</span> <span class="contact-value">-</span>
                            </div>
                            <div class="contact-item" data-limb="left_foot">
                                <span style="color: #888;">Left Foot:</span> <span class="contact-value">-</span>
                            </div>
                            <div class="contact-item" data-limb="right_foot">
                                <span style="color: #888;">Right Foot:</span> <span class="contact-value">-</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Additional visualizations -->
            <div id="visual-grid" class="image-grid" style="margin-top: 16px;">
            </div>
        </section>

        <section class="card">
            <div class="card-header">
                <h2>Low Efficiency Frames</h2>
                <span id="low-eff-count" class="secondary"></span>
            </div>
            <p class="hint" style="margin-bottom: 12px;">
                Frames where the climber's efficiency score is below threshold. These are moments where technique could
                be improved.
            </p>
            <div class="table-wrapper">
                <table id="low-efficiency-table">
                    <thead>
                        <tr>
                            <th>Frame</th>
                            <th>Timestamp (s)</th>
                            <th>Efficiency Score</th>
                            <th>Suggested Action</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <p id="low-eff-empty" class="hint">No low efficiency frames detected. Good climbing form!</p>
        </section>

        <section class="card">
            <div class="card-header">
                <h2>Efficiency & Recommendations</h2>
                <button id="analysis-refresh" type="button">Refresh</button>
            </div>

            <!-- Climber Profile Form -->
            <div class="climber-profile" id="climber-profile-form">
                <div class="form-group">
                    <label for="climber-height">Height (cm)</label>
                    <input type="number" id="climber-height" placeholder="e.g., 175" min="100" max="250" step="1">
                </div>
                <div class="form-group">
                    <label for="climber-wingspan">Wingspan (cm)</label>
                    <input type="number" id="climber-wingspan" placeholder="e.g., 180" min="100" max="300" step="1">
                </div>
                <div class="form-group">
                    <label for="climber-flexibility">Flexibility (0-1)</label>
                    <input type="range" id="climber-flexibility" min="0" max="1" step="0.1" value="0.5">
                    <span id="flexibility-value" style="color: #888; font-size: 11px;">0.5 (Average)</span>
                </div>
            </div>
            <p class="hint" style="margin-bottom: 16px;">
                Set your physical characteristics to get personalized hold recommendations based on your reach and
                flexibility.
            </p>

            <div id="efficiency-block">
                <p class="hint" id="efficiency-hint">Select a completed run to view analysis.</p>
                <div id="efficiency-score" class="metrics"></div>
                <h4 style="color: #fff; margin: 16px 0 8px 0; font-size: 14px;">Recommended Next Holds</h4>
                <table id="next-holds-table" class="compact">
                    <thead>
                        <tr>
                            <th>Hold ID</th>
                            <th>Type</th>
                            <th>Position</th>
                            <th>Confidence</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </section>
    </main>

    <script src="/static/feedback-widget.js"></script>
    <script src="/static/job-notifications.js"></script>
    <script>
        const form = document.getElementById("pipeline-form");
        const statusEl = document.getElementById("form-status");
        const jobsTableBody = document.querySelector("#jobs-table tbody");
        const logOutput = document.getElementById("log-output");
        const logTitle = document.getElementById("log-title");
        const refreshButton = document.getElementById("refresh");
        const fileInput = document.getElementById("video_file");
        const visualGrid = document.getElementById("visual-grid");
        const clearButton = document.getElementById("clear");
        const runButton = document.getElementById("run");
        const analysisVideo = document.getElementById("analysis-video");
        const videoPlaceholder = document.getElementById("video-placeholder");
        let selectedJobId = null;
        let currentVideoFps = 30; // Default FPS, will be updated from job data
        let lastRecommendationFrame = -1;

        // =====================================================
        // Climber Profile Management
        // =====================================================
        function loadClimberProfile() {
            const height = localStorage.getItem('climber_height');
            const wingspan = localStorage.getItem('climber_wingspan');
            const flexibility = localStorage.getItem('climber_flexibility');

            if (height) document.getElementById('climber-height').value = height;
            if (wingspan) document.getElementById('climber-wingspan').value = wingspan;
            if (flexibility) {
                document.getElementById('climber-flexibility').value = flexibility;
                updateFlexibilityLabel(flexibility);
            }
        }

        function saveClimberProfile() {
            const height = document.getElementById('climber-height').value;
            const wingspan = document.getElementById('climber-wingspan').value;
            const flexibility = document.getElementById('climber-flexibility').value;

            if (height) localStorage.setItem('climber_height', height);
            if (wingspan) localStorage.setItem('climber_wingspan', wingspan);
            if (flexibility) localStorage.setItem('climber_flexibility', flexibility);
        }

        function getClimberProfile() {
            return {
                height: parseFloat(document.getElementById('climber-height').value) || null,
                wingspan: parseFloat(document.getElementById('climber-wingspan').value) || null,
                flexibility: parseFloat(document.getElementById('climber-flexibility').value) || 0.5,
            };
        }

        function updateFlexibilityLabel(value) {
            const label = document.getElementById('flexibility-value');
            if (label) {
                const v = parseFloat(value);
                let text = v.toFixed(1);
                if (v < 0.3) text += ' (Low)';
                else if (v > 0.7) text += ' (High)';
                else text += ' (Average)';
                label.textContent = text;
            }
        }

        // Setup climber profile event listeners
        document.getElementById('climber-height')?.addEventListener('change', saveClimberProfile);
        document.getElementById('climber-wingspan')?.addEventListener('change', saveClimberProfile);
        document.getElementById('climber-flexibility')?.addEventListener('input', (e) => {
            updateFlexibilityLabel(e.target.value);
            saveClimberProfile();
            // Refresh recommendations with new profile
            if (selectedJobId) loadAnalysis(selectedJobId);
        });

        // Load profile on page load
        loadClimberProfile();

        async function createJob(payload) {
            const response = await fetch("/api/jobs", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });
            if (!response.ok) {
                const error = await response.json().catch(() => ({}));
                throw new Error(error.detail || "Failed to start pipeline run");
            }
            return response.json();
        }

        function serializeForm(formData) {
            // Simple form serialization - YOLO settings are managed in /detection page
            return {};
        }

        async function uploadSelectedVideo() {
            if (!fileInput || !fileInput.files || fileInput.files.length === 0) {
                throw new Error("Please select a video file.");
            }
            const uploadData = new FormData();
            uploadData.append("video", fileInput.files[0]);
            const response = await fetch("/api/upload", {
                method: "POST",
                body: uploadData,
            });
            if (!response.ok) {
                const error = await response.json().catch(() => ({}));
                throw new Error(error.detail || "Video upload failed");
            }
            return response.json();
        }

        async function fetchJobs() {
            const response = await fetch("/api/jobs");
            if (!response.ok) {
                throw new Error("Failed to fetch jobs");
            }
            return response.json();
        }

        function renderVisualizations(items) {
            if (!visualGrid) {
                return;
            }
            if (!items || items.length === 0) {
                visualGrid.innerHTML = '<p class="hint">No visualizations yet. Run the pipeline with visualization enabled.</p>';
                return;
            }
            visualGrid.innerHTML = "";
            items.forEach((item) => {
                const figure = document.createElement("figure");
                const link = document.createElement("a");
                link.href = item.url;
                link.target = "_blank";
                link.rel = "noopener noreferrer";

                const img = document.createElement("img");
                img.src = item.url;
                img.alt = item.label || "visualization";
                link.appendChild(img);
                figure.appendChild(link);

                if (item.label) {
                    const caption = document.createElement("figcaption");
                    caption.textContent = item.label;
                    figure.appendChild(caption);
                }
                visualGrid.appendChild(figure);
            });
        }

        // =====================================================
        // Low Efficiency Frames
        // =====================================================
        async function renderLowEfficiencyFrames(jobData, jobId) {
            const tableBody = document.querySelector("#low-efficiency-table tbody");
            const emptyEl = document.getElementById("low-eff-empty");
            const countEl = document.getElementById("low-eff-count");

            if (!tableBody) return;
            tableBody.innerHTML = "";

            if (!jobId || !jobData || jobData.status !== 'completed') {
                if (emptyEl) emptyEl.style.display = "block";
                if (countEl) countEl.textContent = "";
                return;
            }

            try {
                // Fetch ML predictions to get efficiency scores
                const resp = await fetch(`/api/jobs/${jobId}/ml_predictions`);
                if (!resp.ok) {
                    if (emptyEl) emptyEl.style.display = "block";
                    if (countEl) countEl.textContent = "";
                    return;
                }

                const data = await resp.json();
                const predictions = data.predictions || [];

                // Filter low efficiency frames (threshold: 0.5)
                const lowEffFrames = predictions
                    .filter(p => p.efficiency_score < 0.5)
                    .sort((a, b) => a.efficiency_score - b.efficiency_score);

                if (lowEffFrames.length === 0) {
                    if (emptyEl) emptyEl.style.display = "block";
                    if (countEl) countEl.textContent = "";
                    return;
                }

                if (emptyEl) emptyEl.style.display = "none";
                if (countEl) countEl.textContent = `${lowEffFrames.length} frames`;

                lowEffFrames.forEach((frame) => {
                    const row = document.createElement("tr");
                    const score = frame.efficiency_score;
                    const badgeClass = score < 0.3 ? 'low' : 'medium';

                    row.innerHTML = `
                        <td>${frame.frame_index}</td>
                        <td>${(frame.frame_index / currentVideoFps).toFixed(2)}</td>
                        <td><span class="efficiency-badge ${badgeClass}">${score.toFixed(3)}</span></td>
                        <td>${frame.next_action || '-'}</td>
                    `;

                    // Click to jump to this frame in video
                    row.style.cursor = 'pointer';
                    row.addEventListener('click', () => {
                        if (analysisVideo && analysisVideo.src) {
                            analysisVideo.currentTime = frame.frame_index / currentVideoFps;
                        }
                    });

                    tableBody.appendChild(row);
                });
            } catch (err) {
                console.error('Failed to load efficiency predictions:', err);
                if (emptyEl) emptyEl.style.display = "block";
                if (countEl) countEl.textContent = "";
            }
        }

        // =====================================================
        // Video Player and Frame Recommendations
        // =====================================================
        function setupVideoPlayer(videoPath) {
            if (!analysisVideo || !videoPath) {
                if (videoPlaceholder) videoPlaceholder.style.display = 'block';
                if (analysisVideo) {
                    analysisVideo.style.display = 'none';
                    analysisVideo.removeAttribute('controls');
                }
                return;
            }

            // Normalize path: remove leading slash if present, ensure it starts with repo mount
            let normalizedPath = videoPath;
            // Remove leading slash if it's an absolute path indicator
            if (normalizedPath.startsWith('/')) {
                normalizedPath = normalizedPath.substring(1);
            }
            // Remove ROOT_DIR prefix if present (absolute path)
            if (normalizedPath.includes('/Users/') || normalizedPath.includes('C:\\')) {
                // Try to extract relative path - assume it's under data/ or similar
                const match = normalizedPath.match(/(data\/[^\/]+.*)/);
                if (match) {
                    normalizedPath = match[1];
                } else {
                    // If we can't extract, just use as-is and let server handle it
                    console.warn('Could not normalize video path:', videoPath);
                }
            }

            // Set video source
            analysisVideo.src = `/repo/${normalizedPath}`;
            analysisVideo.style.display = 'block';
            if (videoPlaceholder) videoPlaceholder.style.display = 'none';

            // Enable controls only when video is loaded
            analysisVideo.addEventListener('loadedmetadata', () => {
                analysisVideo.setAttribute('controls', 'controls');
            });

            // Load frame recommendations when video is paused
            analysisVideo.addEventListener('pause', () => {
                loadFrameRecommendations();
            });

            // Also update on seeking
            analysisVideo.addEventListener('seeked', () => {
                if (analysisVideo.paused) {
                    loadFrameRecommendations();
                }
            });
        }

        async function loadFrameRecommendations() {
            if (!selectedJobId || !analysisVideo) return;

            const currentTime = analysisVideo.currentTime;
            const frameIndex = Math.floor(currentTime * currentVideoFps);

            // Avoid duplicate requests for same frame
            if (frameIndex === lastRecommendationFrame) return;
            lastRecommendationFrame = frameIndex;

            const profile = getClimberProfile();
            const recommendationsList = document.getElementById('recommendations-list');
            const contactsDisplay = document.getElementById('contacts-display');
            const frameInfo = document.getElementById('frame-info');

            if (frameInfo) {
                frameInfo.textContent = `Frame ${frameIndex} | ${currentTime.toFixed(2)}s`;
            }

            try {
                let url = `/api/jobs/${selectedJobId}/frame-recommendations?frame_index=${frameIndex}`;
                if (profile.height) url += `&climber_height=${profile.height}`;
                if (profile.wingspan) url += `&climber_wingspan=${profile.wingspan}`;
                if (profile.flexibility !== null) url += `&climber_flexibility=${profile.flexibility}`;

                const resp = await fetch(url);
                if (!resp.ok) throw new Error('Failed to load recommendations');

                const data = await resp.json();

                // Render recommendations
                if (recommendationsList) {
                    if (data.recommendations && data.recommendations.length > 0) {
                        recommendationsList.innerHTML = data.recommendations.map((rec, idx) => `
                            <div class="recommendation-card">
                                <span style="color: #666; font-size: 18px; width: 24px;">${idx + 1}</span>
                                <div>
                                    <div class="hold-type">${rec.label || rec.hold_type || 'Hold'}</div>
                                    <div class="hold-info">ID: ${rec.hold_id || '-'}</div>
                                </div>
                                <span class="confidence">${rec.avg_confidence ? (rec.avg_confidence * 100).toFixed(0) + '%' : '-'}</span>
                            </div>
                        `).join('');
                    } else {
                        recommendationsList.innerHTML = '<p class="hint">No recommendations available for this frame.</p>';
                    }
                }

                // Update current contacts
                if (contactsDisplay && data.current_contacts) {
                    ['left_hand', 'right_hand', 'left_foot', 'right_foot'].forEach(limb => {
                        const contactEl = contactsDisplay.querySelector(`[data-limb="${limb}"] .contact-value`);
                        if (contactEl) {
                            const contact = data.current_contacts[limb];
                            if (contact && contact.active) {
                                contactEl.textContent = contact.hold_id || 'Active';
                                contactEl.style.color = '#4ade80';
                            } else {
                                contactEl.textContent = '-';
                                contactEl.style.color = '#666';
                            }
                        }
                    });
                }
            } catch (err) {
                console.error('Failed to load frame recommendations:', err);
                if (recommendationsList) {
                    recommendationsList.innerHTML = '<p class="hint">Unable to load recommendations.</p>';
                }
            }
        }

        async function clearServerJob(jobId) {
            const response = await fetch(`/api/jobs/${jobId}/clear`, { method: "POST" });
            if (!response.ok) {
                const error = await response.json().catch(() => ({}));
                throw new Error(error.detail || "Failed to clear job");
            }
            return response.json();
        }

        function clearDisplays() {
            logTitle.textContent = "No run selected";
            document.getElementById("log-output").textContent = "";
            renderVisualizations([]);
            renderLowEfficiencyFrames(null, null);

            // Reset video player
            if (analysisVideo) {
                analysisVideo.src = '';
                analysisVideo.style.display = 'none';
            }
            if (videoPlaceholder) {
                videoPlaceholder.style.display = 'block';
            }

            // Reset recommendations
            const recommendationsList = document.getElementById('recommendations-list');
            if (recommendationsList) {
                recommendationsList.innerHTML = '<p class="hint">Pause the video to see recommended next moves for that frame.</p>';
            }
        }

        function formatDuration(startedAt, finishedAt) {
            if (!startedAt) return '-';
            const start = new Date(startedAt);
            const end = finishedAt ? new Date(finishedAt) : new Date();
            const diffMs = end - start;
            const diffSec = Math.floor(diffMs / 1000);
            if (diffSec < 60) return `${diffSec}s`;
            const mins = Math.floor(diffSec / 60);
            const secs = diffSec % 60;
            return `${mins}m ${secs}s`;
        }

        function getProgressFromLogs(logs) {
            if (!logs || logs.length === 0) return 'Queued';
            const lastLog = logs[logs.length - 1].toLowerCase();
            if (lastLog.includes('complete') || lastLog.includes('finished')) return 'Done';
            if (lastLog.includes('analysis') || lastLog.includes('efficiency')) return 'Analyzing';
            if (lastLog.includes('feature')) return 'Features';
            if (lastLog.includes('pose')) return 'Pose';
            if (lastLog.includes('hold') || lastLog.includes('detect')) return 'Detection';
            if (lastLog.includes('extract') || lastLog.includes('frame')) return 'Extracting';
            if (lastLog.includes('upload')) return 'Uploading';
            return 'Processing';
        }

        function renderJobs(jobs) {
            jobsTableBody.innerHTML = "";
            jobs.forEach(job => {
                const row = document.createElement("tr");
                row.dataset.jobId = job.id;
                const duration = formatDuration(job.started_at, job.finished_at);
                const frameCount = job.pose_samples ? job.pose_samples.length : '-';
                const progress = job.status === 'completed' ? 'Done' :
                    job.status === 'failed' ? 'Failed' :
                        job.status === 'pending' ? 'Queued' : 'Processing';
                const statusBadge = `<span class="badge badge-${job.status}">${job.status}</span>`;
                const createdDate = new Date(job.created_at).toLocaleString();
                row.innerHTML = `
                    <td title="${job.id}">${job.id.substring(0, 8)}...</td>
                    <td class="status-cell">${statusBadge}</td>
                    <td>${progress}</td>
                    <td>${duration}</td>
                    <td>${frameCount}</td>
                    <td>${createdDate}</td>
                `;
                if (job.id === selectedJobId) {
                    row.classList.add("selected");
                }
                row.addEventListener("click", () => {
                    selectedJobId = job.id;
                    loadLogs(job.id);
                    renderJobs(jobs);
                });
                jobsTableBody.appendChild(row);
            });
        }

        async function refreshJobs() {
            try {
                const jobs = await fetchJobs();
                renderJobs(jobs);
                if (selectedJobId) {
                    await loadLogs(selectedJobId);
                }
            } catch (err) {
                console.error(err);
            }
        }

        function updateProgressSteps(logs, status) {
            const progressEl = document.getElementById('progress-steps');
            if (!progressEl) return;
            progressEl.style.display = 'flex';

            const steps = ['upload', 'extract', 'detect', 'pose', 'features', 'analysis'];
            const stepElements = progressEl.querySelectorAll('.progress-step');

            // Reset all steps
            stepElements.forEach(el => {
                el.classList.remove('completed', 'active', 'failed');
                el.querySelector('.step-status').textContent = '-';
            });

            if (status === 'failed') {
                stepElements.forEach(el => el.classList.add('failed'));
                return;
            }

            if (!logs || logs.length === 0) return;

            const logsLower = logs.map(l => l.toLowerCase()).join(' ');

            // Check each step
            const stepPatterns = {
                upload: ['upload', 'video received'],
                extract: ['extract', 'frame', 'sampl'],
                detect: ['hold', 'detect', 'yolo'],
                pose: ['pose', 'mediapipe', 'skeleton'],
                features: ['feature', 'contact'],
                analysis: ['analysis', 'efficiency', 'recommend', 'complete']
            };

            let lastCompleted = -1;
            steps.forEach((step, idx) => {
                const patterns = stepPatterns[step];
                const found = patterns.some(p => logsLower.includes(p));
                const stepEl = progressEl.querySelector(`[data-step="${step}"]`);
                if (found) {
                    stepEl.classList.add('completed');
                    stepEl.querySelector('.step-status').textContent = '‚úì';
                    lastCompleted = idx;
                }
            });

            // Mark next step as active if job is running
            if (status === 'running' && lastCompleted < steps.length - 1) {
                const nextStep = steps[lastCompleted + 1];
                const nextStepEl = progressEl.querySelector(`[data-step="${nextStep}"]`);
                if (nextStepEl) {
                    nextStepEl.classList.add('active');
                    nextStepEl.querySelector('.step-status').textContent = '...';
                }
            }
        }

        async function loadLogs(jobId) {
            try {
                const response = await fetch(`/api/jobs/${jobId}`);
                if (!response.ok) {
                    throw new Error("Failed to fetch job logs");
                }
                const data = await response.json();
                logTitle.textContent = `Run ${data.id.substring(0, 8)}... (${data.status})`;
                logOutput.textContent = data.logs.join("\n") || "No logs yet.";

                // Update progress steps visualization
                updateProgressSteps(data.logs, data.status);

                // Setup video player if job has video
                if (data.video_path) {
                    // Use video_path (relative path from server) if available
                    setupVideoPlayer(data.video_path);
                } else if (data.video_dir) {
                    // Fallback: try to find video in video_dir (legacy support)
                    const videoPath = data.video_dir;
                    setupVideoPlayer(videoPath);
                }

                renderVisualizations(data.visualizations || []);
                renderLowEfficiencyFrames(data, jobId);
                await loadAnalysis(jobId);
            } catch (err) {
                logTitle.textContent = "Unable to load logs";
                logOutput.textContent = String(err);
                renderVisualizations([]);
                renderLowEfficiencyFrames(null, null);
                clearAnalysis();
            }
        }

        async function loadAnalysis(jobId) {
            const scoreEl = document.getElementById("efficiency-score");
            const hintEl = document.getElementById("efficiency-hint");
            const tableBody = document.querySelector("#next-holds-table tbody");
            if (!jobId || !scoreEl || !tableBody) return;

            try {
                // Build URL with climber profile parameters
                const profile = getClimberProfile();
                let url = `/api/jobs/${jobId}/analysis`;
                const params = new URLSearchParams();
                if (profile.height) params.append('climber_height', profile.height);
                if (profile.wingspan) params.append('climber_wingspan', profile.wingspan);
                if (profile.flexibility !== null) params.append('climber_flexibility', profile.flexibility);
                if (params.toString()) url += '?' + params.toString();

                const resp = await fetch(url);
                if (!resp.ok) throw new Error("Analysis endpoint error");
                const payload = await resp.json();

                // Display analysis info
                let infoText = `Wall angle: ${payload.wall_angle !== null && payload.wall_angle !== undefined ? Number(payload.wall_angle).toFixed(1) + '¬∞' : 'n/a'} | Holds: ${payload.holds_count}`;
                infoText += ` | Frame: ${payload.frame_index + 1}/${payload.total_frames}`;
                if (hintEl) hintEl.textContent = infoText;

                // Show climber profile if set
                const profileInfo = payload.climber_profile;
                if (profileInfo && (profileInfo.height || profileInfo.wingspan)) {
                    scoreEl.innerHTML = `
                        <div style="margin-bottom: 8px; color: #888; font-size: 12px;">
                            Personalized for: ${profileInfo.height ? profileInfo.height + 'cm' : '-'} height, 
                            ${profileInfo.wingspan ? profileInfo.wingspan + 'cm' : '-'} wingspan,
                            ${profileInfo.flexibility !== null ? (profileInfo.flexibility * 100).toFixed(0) + '%' : '-'} flexibility
                        </div>
                    `;
                } else {
                    scoreEl.innerHTML = '';
                }

                // Render next holds table
                tableBody.innerHTML = "";
                (payload.next_holds || []).forEach(h => {
                    const tr = document.createElement("tr");
                    const coords = h.coords || [];
                    const coordStr = coords.length >= 2 ? `(${coords[0].toFixed(2)}, ${coords[1].toFixed(2)})` : '-';
                    const confidence = h.avg_confidence !== undefined ? (h.avg_confidence * 100).toFixed(0) + '%' : '-';
                    tr.innerHTML = `
                        <td>${h.hold_id || h.name || '‚Äî'}</td>
                        <td>${h.hold_type || h.label || '‚Äî'}</td>
                        <td>${coordStr}</td>
                        <td>${confidence}</td>
                    `;
                    tableBody.appendChild(tr);
                });
            } catch (err) {
                console.error('Analysis load error:', err);
                if (scoreEl) scoreEl.textContent = "Analysis unavailable";
            }
        }

        function clearAnalysis() {
            const scoreEl = document.getElementById("efficiency-score");
            const tableBody = document.querySelector("#next-holds-table tbody");
            if (scoreEl) scoreEl.textContent = "";
            if (tableBody) tableBody.innerHTML = "";
            const hintEl = document.getElementById("efficiency-hint");
            if (hintEl) hintEl.textContent = "Select a completed run to view analysis.";
        }

        const analysisRefresh = document.getElementById("analysis-refresh");
        if (analysisRefresh) {
            analysisRefresh.addEventListener("click", () => {
                if (selectedJobId) loadAnalysis(selectedJobId);
            });
        }

        form.addEventListener("submit", async (event) => {
            event.preventDefault();
            statusEl.textContent = "Starting‚Ä¶";
            try {
                const formData = new FormData(form);
                const payload = serializeForm(formData);
                statusEl.textContent = "Uploading video‚Ä¶";
                const uploadResult = await uploadSelectedVideo();
                payload.video_dir = uploadResult.video_dir;
                if (uploadResult.gcs_uri) {
                    payload.source_uri = uploadResult.gcs_uri;
                }
                const job = await createJob(payload);
                statusEl.textContent = `Started run ${job.id}`;
                if (fileInput) {
                    fileInput.value = "";
                }
                selectedJobId = job.id;
                await refreshJobs();
            } catch (err) {
                statusEl.textContent = err.message;
            }
        });

        refreshButton.addEventListener("click", refreshJobs);
        setInterval(refreshJobs, 5000);
        renderVisualizations([]);
        refreshJobs();

        if (clearButton) {
            clearButton.addEventListener("click", async () => {
                try {
                    if (selectedJobId) {
                        await clearServerJob(selectedJobId);
                        await loadLogs(selectedJobId);
                    } else {
                        clearDisplays();
                    }
                } catch (err) {
                    console.error(err);
                }
            });
        }

        // Handle job selection from notification
        window.addEventListener('selectJob', (event) => {
            const jobId = event.detail.jobId;
            if (jobId) {
                selectedJobId = jobId;
                refreshJobs().then(() => {
                    loadLogs(jobId);
                    // Scroll to job in table and highlight it
                    const row = document.querySelector(`tr[data-job-id="${jobId}"]`);
                    if (row) {
                        row.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        row.classList.add('highlight');
                        setTimeout(() => row.classList.remove('highlight'), 2000);
                    }
                });
            }
        });

        // Handle URL parameter for direct job access
        const urlParams = new URLSearchParams(window.location.search);
        const jobIdParam = urlParams.get('job');
        if (jobIdParam) {
            selectedJobId = jobIdParam;
            refreshJobs().then(() => {
                loadLogs(jobIdParam);
            });
        }
    </script>
</body>

</html>